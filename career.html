<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AADS Career Stats Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }
    </style>
</head>
<body class="text-white min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-6xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 text-transparent bg-clip-text mb-4">
                AADS Career Stats Hub
            </h1>
            <p class="text-xl text-gray-300">Automatic Player Career Statistics</p>
            <div class="mt-4">
                <a href="index.html" class="inline-flex items-center text-blue-400 hover:text-blue-300 transition">
                    <span class="text-xl mr-2">‚Üê</span>
                    <span class="font-semibold">Back to Dashboard</span>
                </a>
            </div>
        </div>

        <!-- Setup Instructions -->
        <div id="setupInstructions" class="bg-gradient-to-br from-yellow-900/30 to-orange-900/30 border-2 border-yellow-500/50 rounded-xl p-8 mb-8">
            <h2 class="text-3xl font-bold text-yellow-400 mb-4">üìÇ Setup Required</h2>
            <div class="space-y-4 text-gray-200">
                <p class="text-lg">To use this Career Hub, you need to set up your files structure:</p>
                <div class="bg-gray-900/50 rounded-lg p-6 font-mono text-sm">
                    <p class="text-green-400 mb-2">Your folder structure should be:</p>
                    <pre class="text-gray-300">
üìÅ 2stagestatsprogram/
  üìÑ career.html (this file)
  üìÑ player_profiles.json
  üìÅ results/
    üìÑ Event_1_Final.json
    üìÑ Event_2_Final.json
    üìÑ Event_3_Final.json
    ...</pre>
                </div>
                <div class="space-y-2">
                    <p><strong class="text-blue-400">Step 1:</strong> Create a folder named <code class="bg-gray-900 px-2 py-1 rounded">results</code> in your project directory</p>
                    <p><strong class="text-blue-400">Step 2:</strong> Place all your Event_Final_Stats.json files in that folder</p>
                    <p><strong class="text-blue-400">Step 3:</strong> Make sure player_profiles.json is in the main folder</p>
                    <p><strong class="text-blue-400">Step 4:</strong> Use a local web server (like VS Code Live Server) to view this page</p>
                </div>
            </div>
        </div>

        <!-- Loading Status -->
        <div id="loadingStatus" class="hidden text-center py-12">
            <div class="text-6xl mb-4">‚è≥</div>
            <p class="text-2xl font-bold text-blue-400">Loading Career Data...</p>
            <p class="text-gray-400 mt-2">Scanning event files and player profiles</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-900/30 border-2 border-red-500 rounded-xl p-6 mb-8">
            <h3 class="text-2xl font-bold text-red-400 mb-2">‚ö†Ô∏è Error Loading Data</h3>
            <p class="text-gray-200" id="errorText"></p>
        </div>

        <!-- Players Grid -->
        <div id="playersGrid" class="hidden">
            <h2 class="text-3xl font-bold mb-6 text-center">üéØ Player Roster</h2>
            <div id="playerCards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                <!-- Player cards will be inserted here -->
            </div>
        </div>

        <!-- Player Detail View -->
        <div id="playerDetail" class="hidden">
            <button id="backToRoster" class="mb-6 inline-flex items-center text-blue-400 hover:text-blue-300 transition text-lg">
                <span class="text-2xl mr-2">‚Üê</span>
                <span class="font-semibold">Back to Roster</span>
            </button>

            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl overflow-hidden border-2 border-purple-500/50">
                <!-- Player Header -->
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-8">
                    <div class="flex items-center gap-6">
                        <img id="playerPhoto" src="" alt="Player" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-xl">
                        <div class="flex-1">
                            <h1 id="playerName" class="text-4xl font-bold text-white mb-2"></h1>
                            <p id="playerNickname" class="text-2xl text-purple-100 italic mb-1"></p>
                            <p id="playerHometown" class="text-white/80"></p>
                            <p id="playerDarts" class="text-white/80 text-sm"></p>
                        </div>
                    </div>
                </div>

                <!-- Stats Dashboard -->
                <div class="p-8">
                    <!-- Career Overview -->
                    <div class="grid md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl p-6 text-center">
                            <p class="text-blue-200 text-sm font-semibold mb-1">Career 3DA</p>
                            <p id="careerAvg" class="text-4xl font-bold">0.00</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-600 to-green-800 rounded-xl p-6 text-center">
                            <p class="text-green-200 text-sm font-semibold mb-1">Total 180s</p>
                            <p id="total180s" class="text-4xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-600 to-yellow-800 rounded-xl p-6 text-center">
                            <p class="text-yellow-200 text-sm font-semibold mb-1">Events Played</p>
                            <p id="eventsPlayed" class="text-4xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-xl p-6 text-center">
                            <p class="text-purple-200 text-sm font-semibold mb-1">Win Rate</p>
                            <p id="winRate" class="text-4xl font-bold">0%</p>
                        </div>
                    </div>

                    <!-- Performance Chart -->
                    <div class="bg-gray-800/50 rounded-xl p-6 mb-8">
                        <h3 class="text-2xl font-bold mb-4 text-purple-400">üìà Average Trend</h3>
                        <canvas id="performanceChart"></canvas>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- Scoring Stats -->
                        <div class="bg-gray-800/50 rounded-xl p-6">
                            <h3 class="text-xl font-bold mb-4 text-blue-400">üéØ Scoring Stats</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-300">100+ Scores:</span>
                                    <span id="total100plus" class="font-bold text-white">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">140+ Scores:</span>
                                    <span id="total140plus" class="font-bold text-white">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">High Finish:</span>
                                    <span id="highFinish" class="font-bold text-white">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Checkout Stats -->
                        <div class="bg-gray-800/50 rounded-xl p-6">
                            <h3 class="text-xl font-bold mb-4 text-green-400">‚úì Checkout Stats</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-300">CO Opportunities:</span>
                                    <span id="coOpportunities" class="font-bold text-white">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">CO Completed:</span>
                                    <span id="coCompleted" class="font-bold text-white">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">CO%:</span>
                                    <span id="coPct" class="font-bold text-white">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Event History -->
                    <div class="mt-8 bg-gray-800/50 rounded-xl p-6">
                        <h3 class="text-2xl font-bold mb-4 text-yellow-400">üìÖ Event History</h3>
                        <div id="eventHistory" class="space-y-3">
                            <!-- Event cards will be inserted here -->
                        </div>
                    </div>

                    <!-- Bio -->
                    <div id="playerBioSection" class="mt-8 bg-gradient-to-br from-purple-900/30 to-pink-900/30 rounded-xl p-6 border border-purple-500/30">
                        <h3 class="text-2xl font-bold mb-3 text-purple-400">üìù Bio</h3>
                        <p id="playerBio" class="text-gray-200 leading-relaxed"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventFiles = [];
        let playerProfiles = [];
        let currentChart = null;

        // Configuration: List your event files here
        // Add more files as you create them (Final_Series1_Event1.json, Final_Series1_Event2.json, etc.)
        const EVENT_FILES = [
            'results/Final_Series1_Event1.json',
            'results/Final_Series1_Event2.json',
            'results/Final_Series1_Event3.json',
            'results/Final_Series2_Event1.json',
            'results/Final_Series2_Event2.json',
            'results/Final_Series2_Event3.json',
            // Add more event files here as you create them
        ];

        // Initialize
        async function init() {
            document.getElementById('loadingStatus').classList.remove('hidden');
            document.getElementById('setupInstructions').classList.add('hidden');

            try {
                // Load player profiles
                const profilesResponse = await fetch('player_profiles.json');
                if (!profilesResponse.ok) throw new Error('Could not load player_profiles.json');
                playerProfiles = await profilesResponse.json();

                // Load all event files
                const eventPromises = EVENT_FILES.map(file => 
                    fetch(file)
                        .then(res => res.ok ? res.json() : null)
                        .catch(() => null)
                );
                
                const events = await Promise.all(eventPromises);
                eventFiles = events.filter(e => e !== null);

                if (eventFiles.length === 0) {
                    throw new Error('No event files found. Make sure files exist in the results/ folder.');
                }

                // Build and display player roster
                buildPlayerRoster();
                
                document.getElementById('loadingStatus').classList.add('hidden');
                document.getElementById('playersGrid').classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingStatus').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
                
                // Provide helpful error message for file:// protocol
                if (error.message.includes('Failed to fetch') || error.message.includes('fetch')) {
                    document.getElementById('errorText').innerHTML = `
                        <strong>Cannot load files directly from file:// protocol</strong><br><br>
                        Please use one of these methods:<br><br>
                        <strong>Option 1: VS Code Live Server</strong><br>
                        1. Install "Live Server" extension in VS Code<br>
                        2. Right-click career.html ‚Üí "Open with Live Server"<br><br>
                        <strong>Option 2: Python Server</strong><br>
                        1. Open PowerShell in this folder<br>
                        2. Run: <code class="bg-gray-700 px-2 py-1 rounded">python -m http.server 8000</code><br>
                        3. Open: <code class="bg-gray-700 px-2 py-1 rounded">http://localhost:8000/career.html</code>
                    `;
                } else {
                    document.getElementById('errorText').textContent = error.message;
                }
            }
        }

        // Build player roster from all events
        function buildPlayerRoster() {
            const playerMap = new Map();

            // Collect all unique players from all events
            eventFiles.forEach(event => {
                if (event.player_event_stats) {
                    event.player_event_stats.forEach(player => {
                        if (!playerMap.has(player.name)) {
                            playerMap.set(player.name, {
                                name: player.name,
                                events: []
                            });
                        }
                    });
                }
            });

            // Render player cards
            const container = document.getElementById('playerCards');
            container.innerHTML = '';

            playerMap.forEach((player, name) => {
                const profile = playerProfiles.find(p => p.name === name) || {};
                const careerStats = calculateCareerStats(name);

                const card = document.createElement('div');
                card.className = 'bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-6 border-2 border-purple-500/30 hover:border-purple-500 transition cursor-pointer shadow-lg hover:shadow-purple-500/50';
                card.onclick = () => showPlayerDetail(name);

                card.innerHTML = `
                    <div class="flex items-center gap-4 mb-4">
                        ${profile.imageBase64 ? 
                            `<img src="${profile.imageBase64}" alt="${name}" class="w-16 h-16 rounded-full object-cover border-2 border-purple-500">` :
                            `<div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center text-3xl">üéØ</div>`
                        }
                        <div class="flex-1">
                            <h3 class="font-bold text-xl text-white">${name}</h3>
                            ${profile.nickname ? `<p class="text-purple-300 italic text-sm">"${profile.nickname}"</p>` : ''}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-blue-600/20 rounded-lg p-2 text-center">
                            <p class="text-blue-300 text-xs">Career 3DA</p>
                            <p class="font-bold text-white">${careerStats.career3DA.toFixed(2)}</p>
                        </div>
                        <div class="bg-green-600/20 rounded-lg p-2 text-center">
                            <p class="text-green-300 text-xs">180s</p>
                            <p class="font-bold text-white">${careerStats.total180s}</p>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // Calculate career stats for a player
        function calculateCareerStats(playerName) {
            let totalMatches = 0;
            let total3DASum = 0;
            let total180s = 0;
            let total100plus = 0;
            let total140plus = 0;
            let totalWins = 0;
            let totalLosses = 0;
            let coOpportunities = 0;
            let coCompleted = 0;
            let highFinish = 0;
            const eventHistory = [];

            eventFiles.forEach(event => {
                const playerStats = event.player_event_stats?.find(p => p.name === playerName);
                if (playerStats) {
                    // For career 3DA: sum all match averages from all events
                    totalMatches += playerStats.total_matches;
                    total3DASum += playerStats.final_event_3da * playerStats.total_matches;
                    
                    total180s += playerStats.scores_180 || 0;
                    total100plus += playerStats.scores_100plus || 0;
                    total140plus += playerStats.scores_140plus || 0;
                    totalWins += playerStats.wins || 0;
                    totalLosses += playerStats.losses || 0;
                    coOpportunities += playerStats.co_opportunities || 0;
                    coCompleted += playerStats.co_completed || 0;
                    highFinish = Math.max(highFinish, playerStats.high_finish || 0);

                    eventHistory.push({
                        eventName: event.metadata.event_name,
                        date: event.metadata.date,
                        avg: playerStats.final_event_3da,
                        wins: playerStats.wins,
                        losses: playerStats.losses
                    });
                }
            });

            const career3DA = totalMatches > 0 ? total3DASum / totalMatches : 0;
            const winRate = (totalWins + totalLosses) > 0 ? (totalWins / (totalWins + totalLosses) * 100) : 0;
            const coPct = coOpportunities > 0 ? (coCompleted / coOpportunities * 100) : 0;

            return {
                career3DA,
                total180s,
                total100plus,
                total140plus,
                totalWins,
                totalLosses,
                winRate,
                coOpportunities,
                coCompleted,
                coPct,
                highFinish,
                eventsPlayed: eventHistory.length,
                eventHistory
            };
        }

        // Show player detail
        function showPlayerDetail(playerName) {
            const profile = playerProfiles.find(p => p.name === playerName) || {};
            const stats = calculateCareerStats(playerName);

            // Update player info
            document.getElementById('playerName').textContent = playerName;
            document.getElementById('playerNickname').textContent = profile.nickname ? `"${profile.nickname}"` : '';
            document.getElementById('playerHometown').textContent = profile.hometown || '';
            document.getElementById('playerDarts').textContent = profile.dartsSetup ? `üéØ ${profile.dartsSetup}` : '';
            
            if (profile.imageBase64) {
                document.getElementById('playerPhoto').src = profile.imageBase64;
            } else {
                document.getElementById('playerPhoto').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><text x="50%" y="50%" font-size="50" text-anchor="middle" dy=".3em">üéØ</text></svg>';
            }

            // Update stats
            document.getElementById('careerAvg').textContent = stats.career3DA.toFixed(2);
            document.getElementById('total180s').textContent = stats.total180s;
            document.getElementById('eventsPlayed').textContent = stats.eventsPlayed;
            document.getElementById('winRate').textContent = stats.winRate.toFixed(1) + '%';
            document.getElementById('total100plus').textContent = stats.total100plus;
            document.getElementById('total140plus').textContent = stats.total140plus;
            document.getElementById('highFinish').textContent = stats.highFinish;
            document.getElementById('coOpportunities').textContent = stats.coOpportunities;
            document.getElementById('coCompleted').textContent = stats.coCompleted;
            document.getElementById('coPct').textContent = stats.coPct.toFixed(1) + '%';

            // Bio
            if (profile.bio) {
                document.getElementById('playerBio').textContent = profile.bio;
                document.getElementById('playerBioSection').classList.remove('hidden');
            } else {
                document.getElementById('playerBioSection').classList.add('hidden');
            }

            // Event history
            const historyContainer = document.getElementById('eventHistory');
            historyContainer.innerHTML = stats.eventHistory.map(event => `
                <div class="bg-gray-700/50 rounded-lg p-4 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-white">${event.eventName}</p>
                        <p class="text-sm text-gray-400">${event.date}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-blue-400">${event.avg.toFixed(2)}</p>
                        <p class="text-sm text-gray-400">${event.wins}W - ${event.losses}L</p>
                    </div>
                </div>
            `).join('');

            // Create chart
            createPerformanceChart(stats.eventHistory);

            // Show detail view
            document.getElementById('playersGrid').classList.add('hidden');
            document.getElementById('playerDetail').classList.remove('hidden');
        }

        // Create performance chart
        function createPerformanceChart(eventHistory) {
            const ctx = document.getElementById('performanceChart');
            
            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: eventHistory.map(e => e.eventName),
                    datasets: [{
                        label: 'Event Average',
                        data: eventHistory.map(e => e.avg),
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9CA3AF'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9CA3AF'
                            }
                        }
                    }
                }
            });
        }

        // Back to roster
        document.getElementById('backToRoster').addEventListener('click', () => {
            document.getElementById('playerDetail').classList.add('hidden');
            document.getElementById('playersGrid').classList.remove('hidden');
        });

        // Initialize on page load
        init();
    </script>
</body>
</html>
