<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Profile Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="mb-6">
            <a href="index.html" class="inline-flex items-center text-blue-400 hover:text-blue-300 transition">
                <span class="text-2xl mr-2">‚Üê</span>
                <span class="font-semibold">Back to Dashboard</span>
            </a>
        </div>
        
        <h1 class="text-4xl font-bold text-center mb-8 text-purple-400">Player Profile Editor</h1>
        
        <!-- Import Players from Event Stats -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8 border-2 border-blue-500">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">üì• Import Players from Event Stats</h2>
            <p class="text-gray-400 mb-4 text-sm">Upload Event_Final_Stats.json to automatically detect all players from the event.</p>
            <div class="flex gap-3 items-center mb-3">
                <input type="file" id="uploadEventFile" accept=".json" class="flex-1 block text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                <button id="uploadEventButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition whitespace-nowrap">
                    Import Players
                </button>
            </div>
            <div id="eventUploadStatus" class="hidden mt-2 p-3 bg-green-900 bg-opacity-30 rounded-lg border border-green-600">
                <p class="text-green-400 font-bold">‚úì <span id="importedCount">0</span> players imported successfully!</p>
            </div>
            <div id="eventUploadError" class="hidden mt-2 p-3 bg-red-900 bg-opacity-30 rounded-lg border border-red-600">
                <p class="text-red-400 font-bold">‚úó Error importing players. Please check the file format.</p>
            </div>
        </div>
        
        <!-- Upload Existing Profiles -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8 border-2 border-orange-500">
            <h2 class="text-2xl font-bold mb-4 text-orange-300">üì§ Upload Existing Profiles</h2>
            <p class="text-gray-400 mb-4 text-sm">Load an existing player_profiles.json file (or extract from ZIP) to edit profiles.</p>
            <div class="flex gap-3 items-center mb-3">
                <input type="file" id="uploadProfilesFile" accept=".json" class="flex-1 block text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-orange-600 file:text-white hover:file:bg-orange-700">
                <button id="uploadProfilesButton" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-lg transition whitespace-nowrap">
                    Upload
                </button>
            </div>
            <div id="uploadStatus" class="hidden mt-2 p-3 bg-green-900 bg-opacity-30 rounded-lg border border-green-600">
                <p class="text-green-400 font-bold">‚úì Profiles loaded successfully!</p>
            </div>
            <div id="uploadError" class="hidden mt-2 p-3 bg-red-900 bg-opacity-30 rounded-lg border border-red-600">
                <p class="text-red-400 font-bold">‚úó Error uploading file. Please check the file format.</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Left: Profile Form -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 border-2 border-blue-500">
                <h2 class="text-2xl font-bold mb-6 text-blue-300">Add/Edit Player Profile</h2>
                
                <form id="profileForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Player Name *</label>
                        <input 
                            type="text" 
                            id="playerName" 
                            required
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="John Smith"
                        >
                        <p class="text-xs text-gray-400 mt-1">Must match the name used in stats files</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Nickname</label>
                        <input 
                            type="text" 
                            id="nickname" 
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="The Power"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Hometown</label>
                        <input 
                            type="text" 
                            id="hometown" 
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Las Vegas, NV"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Darts Setup</label>
                        <input 
                            type="text" 
                            id="dartsSetup" 
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="24g Target Steeltip"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Bio</label>
                        <textarea 
                            id="bio" 
                            rows="4"
                            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Short biography..."
                        ></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-300">Player Photo</label>
                        <input 
                            type="file" 
                            id="photoUpload" 
                            accept="image/*"
                            class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700"
                        >
                        <div id="photoPreview" class="hidden mt-3">
                            <p class="text-sm text-gray-400 mb-2">Preview:</p>
                            <img id="previewImage" src="" alt="Preview" class="w-32 h-32 object-cover rounded-lg border-2 border-gray-600">
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button 
                            type="submit" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-lg"
                        >
                            Add/Update Player
                        </button>
                        <button 
                            type="button" 
                            id="clearForm"
                            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200"
                        >
                            Clear
                        </button>
                    </div>
                </form>
            </div>

            <!-- Right: Players List -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 border-2 border-green-500">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-green-300">Player Profiles</h2>
                    <button 
                        id="downloadProfiles" 
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm"
                    >
                        üíæ Download Player Profiles (ZIP)
                    </button>
                </div>

                <div id="playersList" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">No players added yet. Add your first player using the form.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let profiles = [];
        let editingIndex = -1;
        let currentImageBase64 = '';

        // Format name for display (convert "Last, First" to "First Last")
        function formatNameForDisplay(name) {
            if (name.includes(',')) {
                const parts = name.split(',').map(p => p.trim());
                return `${parts[1]} ${parts[0]}`;
            }
            return name;
        }

        // Import players from Event Stats
        document.getElementById('uploadEventButton').addEventListener('click', function() {
            const fileInput = document.getElementById('uploadEventFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an event stats file first!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const eventData = JSON.parse(event.target.result);
                    
                    if (!eventData.player_event_stats || !Array.isArray(eventData.player_event_stats)) {
                        document.getElementById('eventUploadError').classList.remove('hidden');
                        document.getElementById('eventUploadStatus').classList.add('hidden');
                        setTimeout(() => {
                            document.getElementById('eventUploadError').classList.add('hidden');
                        }, 3000);
                        return;
                    }

                    let importCount = 0;
                    
                    console.log('Current profiles array:', profiles);
                    console.log('Profiles count:', profiles.length);
                    
                    // Import players that don't already have profiles
                    eventData.player_event_stats.forEach(playerStats => {
                        // Format the name from "Last, First" to "First Last"
                        const formattedName = formatNameForDisplay(playerStats.name);
                        
                        console.log('Checking player:', formattedName);
                        
                        // Normalize names for comparison (lowercase, trim whitespace)
                        const normalizedNewName = formattedName.toLowerCase().trim();
                        const existingIndex = profiles.findIndex(p => 
                            p.name.toLowerCase().trim() === normalizedNewName
                        );
                        
                        console.log('  Normalized:', normalizedNewName);
                        console.log('  Existing index:', existingIndex);
                        
                        if (existingIndex === -1) {
                            // Create new profile with empty fields
                            profiles.push({
                                name: formattedName,
                                nickname: '',
                                hometown: '',
                                dartsSetup: '',
                                bio: '',
                                imageBase64: ''
                            });
                            importCount++;
                            console.log('  ‚Üí IMPORTED (new player)');
                        } else {
                            console.log('  ‚Üí SKIPPED (already exists)');
                        }
                    });

                    renderPlayersList();
                    
                    document.getElementById('importedCount').textContent = importCount;
                    document.getElementById('eventUploadStatus').classList.remove('hidden');
                    document.getElementById('eventUploadError').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('eventUploadStatus').classList.add('hidden');
                    }, 3000);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    document.getElementById('eventUploadError').classList.remove('hidden');
                    document.getElementById('eventUploadStatus').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('eventUploadError').classList.add('hidden');
                    }, 3000);
                }
            };
            reader.readAsText(file);
        });

        // Handle photo upload and preview
        document.getElementById('photoUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                currentImageBase64 = event.target.result;
                document.getElementById('previewImage').src = currentImageBase64;
                document.getElementById('photoPreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        // Upload existing profiles
        document.getElementById('uploadProfilesButton').addEventListener('click', function() {
            const fileInput = document.getElementById('uploadProfilesFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file first!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const uploadedProfiles = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(uploadedProfiles)) {
                        document.getElementById('uploadError').classList.remove('hidden');
                        document.getElementById('uploadStatus').classList.add('hidden');
                        setTimeout(() => {
                            document.getElementById('uploadError').classList.add('hidden');
                        }, 3000);
                        return;
                    }

                    profiles = uploadedProfiles;
                    renderPlayersList();
                    
                    document.getElementById('uploadStatus').classList.remove('hidden');
                    document.getElementById('uploadError').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('uploadStatus').classList.add('hidden');
                    }, 3000);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    document.getElementById('uploadError').classList.remove('hidden');
                    document.getElementById('uploadStatus').classList.add('hidden');
                    setTimeout(() => {
                        document.getElementById('uploadError').classList.add('hidden');
                    }, 3000);
                }
            };
            reader.readAsText(file);
        });

        // Handle form submission
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const playerName = document.getElementById('playerName').value.trim();
            const nickname = document.getElementById('nickname').value.trim();
            const hometown = document.getElementById('hometown').value.trim();
            const dartsSetup = document.getElementById('dartsSetup').value.trim();
            const bio = document.getElementById('bio').value.trim();

            if (!playerName) {
                alert('Player Name is required!');
                return;
            }

            const profile = {
                name: playerName,
                nickname: nickname || '',
                hometown: hometown || '',
                dartsSetup: dartsSetup || '',
                bio: bio || '',
                imageBase64: currentImageBase64 || ''
            };

            if (editingIndex >= 0) {
                // Update existing
                profiles[editingIndex] = profile;
                editingIndex = -1;
            } else {
                // Check for duplicate name
                const existingIndex = profiles.findIndex(p => p.name === playerName);
                if (existingIndex >= 0) {
                    if (confirm(`A profile for "${playerName}" already exists. Do you want to update it?`)) {
                        profiles[existingIndex] = profile;
                    } else {
                        return;
                    }
                } else {
                    // Add new
                    profiles.push(profile);
                }
            }

            renderPlayersList();
            clearForm();
        });

        // Clear form
        document.getElementById('clearForm').addEventListener('click', clearForm);

        function clearForm() {
            document.getElementById('profileForm').reset();
            document.getElementById('photoPreview').classList.add('hidden');
            currentImageBase64 = '';
            editingIndex = -1;
        }

        // Render players list
        function renderPlayersList() {
            const container = document.getElementById('playersList');
            
            if (profiles.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No players added yet. Add your first player using the form.</p>';
                return;
            }

            container.innerHTML = profiles.map((profile, index) => `
                <div class="bg-gray-700 p-4 rounded-lg flex items-center gap-4">
                    ${profile.imageBase64 ? 
                        `<img src="${profile.imageBase64}" alt="${profile.name}" class="w-16 h-16 object-cover rounded-lg border-2 border-gray-600">` :
                        `<div class="w-16 h-16 bg-gray-600 rounded-lg flex items-center justify-center text-gray-400 text-2xl">üë§</div>`
                    }
                    <div class="flex-1">
                        <h3 class="font-bold text-white">${profile.name}</h3>
                        ${profile.nickname ? `<p class="text-sm text-blue-300">"${profile.nickname}"</p>` : ''}
                        ${profile.hometown ? `<p class="text-xs text-gray-400">${profile.hometown}</p>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="editProfile(${index})"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition text-sm"
                        >
                            Edit
                        </button>
                        <button 
                            onclick="deleteProfile(${index})"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition text-sm"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Edit profile
        window.editProfile = function(index) {
            const profile = profiles[index];
            editingIndex = index;

            document.getElementById('playerName').value = profile.name;
            document.getElementById('nickname').value = profile.nickname;
            document.getElementById('hometown').value = profile.hometown;
            document.getElementById('dartsSetup').value = profile.dartsSetup;
            document.getElementById('bio').value = profile.bio;
            
            if (profile.imageBase64) {
                currentImageBase64 = profile.imageBase64;
                document.getElementById('previewImage').src = currentImageBase64;
                document.getElementById('photoPreview').classList.remove('hidden');
            }

            // Scroll to form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // Delete profile
        window.deleteProfile = function(index) {
            const profile = profiles[index];
            if (confirm(`Are you sure you want to delete the profile for "${profile.name}"?`)) {
                profiles.splice(index, 1);
                renderPlayersList();
            }
        };

        // Download profiles
        document.getElementById('downloadProfiles').addEventListener('click', async function() {
            if (profiles.length === 0) {
                alert('No profiles to download! Add at least one player first.');
                return;
            }

            // Create a new ZIP file
            const zip = new JSZip();
            
            // Process profiles to extract images
            const processedProfiles = [];
            const imagesFolder = zip.folder("images").folder("players");
            
            for (const profile of profiles) {
                const processedProfile = { ...profile };
                
                // If profile has base64 image, extract it
                if (profile.imageBase64 && profile.imageBase64.startsWith('data:')) {
                    // Create filename from player name
                    const filename = profile.name.toLowerCase()
                        .replace(/[^a-z0-9\s]/g, '')
                        .replace(/\s+/g, '-') + '.png';
                    
                    // Extract base64 data
                    const base64Data = profile.imageBase64.replace(/^data:image\/[^;]+;base64,/, '');
                    
                    // Add image to ZIP
                    imagesFolder.file(filename, base64Data, { base64: true });
                    
                    // Update profile to reference filename instead of base64
                    processedProfile.imageBase64 = filename;
                }
                
                processedProfiles.push(processedProfile);
            }
            
            // Add JSON to ZIP
            zip.file("player_profiles.json", JSON.stringify(processedProfiles, null, 2));
            
            // Generate ZIP and download
            const blob = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'player_profiles.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('player_profiles.zip downloaded! Extract it in your project root folder.');
        });

        // Initial render
        renderPlayersList();
    </script>
</body>
</html>
